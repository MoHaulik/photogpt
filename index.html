<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>WebXR Photo Gallery</title>
  <style>
    body { margin:0; font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif; background:#f2f2f7; overflow-x:hidden; }
    .header { position:sticky; top:0; background:rgba(255,255,255,0.9); padding:16px; border-bottom:1px solid rgba(0,0,0,0.1); }
    .header h1 { margin:0; font-size:24px; }
    .gallery-container { padding:10px; max-width:1200px; margin:0 auto; }
    .gallery-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(150px,1fr)); gap:8px; }
    @media(min-width:768px){ .gallery-grid { grid-template-columns:repeat(auto-fill,minmax(200px,1fr)); gap:12px; }}
    .photo-item { position:relative; padding-bottom:100%; overflow:hidden; border-radius:8px; cursor:pointer; box-shadow:0 1px 3px rgba(0,0,0,0.1); transition:transform .2s,box-shadow .2s; background:#e0e0e0; }
    .photo-item:hover { transform:scale(1.02); box-shadow:0 4px 8px rgba(0,0,0,0.15); }
    .photo-item img { position:absolute; width:100%; height:100%; object-fit:cover; }
    .xr-canvas { position:fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:1; }
    .xr-active .xr-canvas { pointer-events:auto; }
    .enter-ar-button { position:fixed; bottom:30px; left:50%; transform:translateX(-50%); padding:12px 24px; background:rgba(0,122,255,0.9); color:#fff; border:none; border-radius:30px; font-weight:600; cursor:pointer; box-shadow:0 4px 12px rgba(0,122,255,0.3); z-index:100; }
    .exit-ar { position:fixed; top:20px; right:20px; width:44px; height:44px; border:none; border-radius:50%; background:rgba(255,255,255,0.6); font-size:24px; line-height:44px; text-align:center; cursor:pointer; display:none; z-index:100; }
    .xr-active .exit-ar { display:block; }
    #status { position:fixed; bottom:100px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.5); color:#fff; padding:12px 20px; border-radius:24px; text-align:center; display:none; z-index:100; }
  </style>
</head>
<body>
  <header class="header"><h1>Photo Gallery</h1></header>
  <div class="gallery-container">
    <div class="gallery-grid" id="photo-grid"></div>
  </div>
  <div class="xr-canvas" id="xr-canvas"></div>
  <button class="enter-ar-button" id="enter-ar">Enter AR Gallery</button>
  <button class="exit-ar" id="exit-ar">Ã—</button>
  <div id="status"></div>

  <script type="module">
    import * as THREE from 'https://unpkg.com/three@0.150.1/build/three.module.js';
    const photoURLs = ['./Photo/photo1.jpg','./Photo/photo2.jpg','./Photo/photo3.jpg','./Photo/photo4.jpg','./Photo/photo5.jpg'];
    let camera, scene, renderer, xrSession, controllers = [], active = new Set(), selected = null;

    function initPhotoGrid() {
      const grid = document.getElementById('photo-grid');
      photoURLs.forEach(url => {
        const item = document.createElement('div'); item.className = 'photo-item';
        const img = document.createElement('img'); img.src = url;
        item.appendChild(img);
        item.addEventListener('click', () => {
          if (document.body.classList.contains('xr-active')) createPhotoInAR(url);
        });
        grid.appendChild(item);
      });
    }

    function initXR() {
      scene = new THREE.Scene();
      camera = new THREE.PerspectiveCamera(70, innerWidth/innerHeight, .01, 20);
      renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
      renderer.setSize(innerWidth, innerHeight); renderer.xr.enabled = true;
      document.getElementById('xr-canvas').appendChild(renderer.domElement);
      scene.add(new THREE.AmbientLight(0x404040,2));
      const dl = new THREE.DirectionalLight(0xffffff,1.5); dl.position.set(1,1,1); scene.add(dl);
      window.addEventListener('resize', () => {
        camera.aspect = innerWidth/innerHeight; camera.updateProjectionMatrix();
        renderer.setSize(innerWidth, innerHeight);
      });
    }

    function startAR() {
      if (!navigator.xr) return updateStatus('WebXR not supported');
      navigator.xr.isSessionSupported('immersive-ar').then(ok => {
        if (!ok) return updateStatus('AR not supported');
        navigator.xr.requestSession('immersive-ar', { requiredFeatures:['hit-test'], optionalFeatures:['dom-overlay'], domOverlay:{root:document.body} })
          .then(session => onSessionStart(session));
      });
    }

    function onSessionStart(session) {
      xrSession = session; renderer.xr.setSession(session);
      document.body.classList.add('xr-active');
      setupControllers(); renderer.setAnimationLoop(render);
      session.addEventListener('end', endAR);
      updateStatus('AR mode: tap photo to place');
    }

    function endAR() {
      xrSession=null; renderer.setAnimationLoop(null);
      document.body.classList.remove('xr-active'); clearScene(); updateStatus('');
    }

    function clearScene() { while(scene.children.length) scene.remove(scene.children[0]); }

    function createPhotoInAR(url) {
      const loader = new THREE.TextureLoader();
      const w=0.5, ar=4/3, h=w/ar;
      const geo=new THREE.PlaneGeometry(w,h);
      const mat=new THREE.MeshBasicMaterial({ color:0xcccccc, side:THREE.DoubleSide });
      const mesh=new THREE.Mesh(geo,mat);
      const offset=new THREE.Vector3(0,0,-0.8).applyQuaternion(camera.quaternion);
      mesh.position.copy(camera.position).add(offset);
      mesh.quaternion.copy(camera.quaternion);
      scene.add(mesh);
      loader.load(url, tex => { mesh.material.map=tex; mesh.material.color.set(0xffffff); updateStatus('Placed photo'); });
    }

    function setupControllers() {
      for (let i=0;i<2;i++) {
        const c = renderer.xr.getController(i);
        scene.add(c); controllers.push(c);
      }
    }

    function render(time, frame) { renderer.render(scene, camera); }

    function updateStatus(msg) {
      const s = document.getElementById('status');
      s.textContent=msg; s.style.display= msg? 'block':'none';
      if (msg) setTimeout(()=>s.style.display='none',4000);
    }

    document.addEventListener('DOMContentLoaded', () => {
      initPhotoGrid(); initXR();
      document.getElementById('enter-ar').addEventListener('click', startAR);
      document.getElementById('exit-ar').addEventListener('click', endAR);
    });
  </script>
</body>
</html>
