<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>WebXR Photo Gallery - Consistent UI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <style>
    body { margin:0; font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif; background:#f2f2f7; color:#1c1c1e; overflow-x:hidden; }
    .header { background:rgba(255,255,255,0.92); position:sticky; top:0; padding:16px 20px; border-bottom:1px solid rgba(0,0,0,0.1); z-index:100; backdrop-filter:blur(10px); }
    .header h1 { margin:0; font-size:28px; font-weight:700; }
    .enter-ar-button { position:fixed; bottom:30px; left:50%; transform:translateX(-50%); padding:12px 24px; background:rgba(0,122,255,0.9); color:#fff; border:none; border-radius:30px; font-size:16px; font-weight:600; cursor:pointer; box-shadow:0 4px 12px rgba(0,122,255,0.3); z-index:100; }
    .gallery-container { padding:10px; max-width:1200px; margin:0 auto; }
    .gallery-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(150px,1fr)); gap:8px; padding:4px; }
    @media(min-width:768px){ .gallery-grid { grid-template-columns:repeat(auto-fill,minmax(200px,1fr)); gap:12px; }}
    .photo-item { position:relative; padding-bottom:100%; overflow:hidden; border-radius:8px; cursor:pointer; box-shadow:0 1px 3px rgba(0,0,0,0.1); transition:transform .2s,box-shadow .2s; background:#e0e0e0; }
    .photo-item:hover { transform:scale(1.02); box-shadow:0 4px 8px rgba(0,0,0,0.15); }
    .photo-item img { position:absolute; width:100%; height:100%; object-fit:cover; }
    .xr-canvas { position:fixed; top:0; left:0; width:100%; height:100%; z-index:1; pointer-events:none; }
    .xr-active .xr-canvas { pointer-events:auto; }
    /* No layout changes in XR mode */
    .exit-ar { position:fixed; top:20px; right:20px; background:rgba(255,255,255,0.25); color:#fff; border:none; border-radius:50%; width:50px; height:50px; display:flex; align-items:center; justify-content:center; font-size:24px; cursor:pointer; backdrop-filter:blur(5px); box-shadow:0 2px 10px rgba(0,0,0,0.2); z-index:1000; display:none; }
    .xr-active .exit-ar { display:flex; }
    #status { position:fixed; bottom:140px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.5); color:#fff; padding:12px 20px; border-radius:24px; font-size:16px; font-weight:500; text-align:center; display:none; z-index:1000; }
  </style>
</head>
<body>
  <header class="header"><h1>Photo Gallery</h1></header>
  <div class="gallery-container">
    <div class="gallery-grid" id="photo-grid"></div>
  </div>
  <div class="xr-canvas" id="xr-canvas"></div>
  <button class="enter-ar-button" id="enter-ar">Enter AR Gallery</button>
  <button class="exit-ar" id="exit-ar">Ã—</button>
  <div id="status"></div>

  <script type="module">
    import * as THREE from 'https://unpkg.com/three@0.150.1/build/three.module.js';

    const photoURLs = ['./Photo/photo1.jpg','./Photo/photo2.jpg','./Photo/photo3.jpg','./Photo/photo4.jpg','./Photo/photo5.jpg'];
    let camera, scene, renderer, xrSession;

    function initPhotoGrid() {
      const grid = document.getElementById('photo-grid');
      photoURLs.forEach((url) => {
        const item = document.createElement('div');
        item.className = 'photo-item';
        const img = document.createElement('img'); img.src = url; img.loading = 'lazy';
        item.appendChild(img);
        item.addEventListener('click', () => {
          if (document.body.classList.contains('xr-active')) {
            createPhotoInAR(url);
          }
        });
        grid.appendChild(item);
      });
    }

    function initXR() {
      scene = new THREE.Scene();
      camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.01, 20);
      renderer = new THREE.WebGLRenderer({antialias:true, alpha:true});
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.xr.enabled = true;
      document.getElementById('xr-canvas').appendChild(renderer.domElement);
      scene.add(new THREE.AmbientLight(0x404040, 2));
      const dir = new THREE.DirectionalLight(0xffffff, 1.5);
      dir.position.set(1,1,1); scene.add(dir);
      window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth/window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      });
    }

    function startARSession() {
      if (!navigator.xr) return updateStatus('WebXR not supported');
      navigator.xr.isSessionSupported('immersive-ar').then((supported) => {
        if (!supported) return updateStatus('AR not supported');
        navigator.xr.requestSession('immersive-ar', {
          requiredFeatures: ['hit-test'],
          optionalFeatures: ['dom-overlay'],
          domOverlay: { root: document.body }
        }).then(onSessionStarted);
      });
    }

    function onSessionStarted(session) {
      xrSession = session;
      renderer.xr.setReferenceSpaceType('local');
      renderer.xr.setSession(session);
      document.body.classList.add('xr-active');
      session.addEventListener('end', onSessionEnd);
      renderer.setAnimationLoop((_, frame) => renderer.render(scene, camera));
      updateStatus('AR mode: tap thumbnails to place');
    }

    function onSessionEnd() {
      xrSession = null;
      renderer.setAnimationLoop(null);
      document.body.classList.remove('xr-active');
      scene.clear();
      updateStatus('');
    }

    function createPhotoInAR(url) {
      const loader = new THREE.TextureLoader();
      const width = 0.5, ar = 4/3, height = width/ar;
      const geometry = new THREE.PlaneGeometry(width, height);
      const material = new THREE.MeshBasicMaterial({ color:0xcccccc, side: THREE.DoubleSide });
      const mesh = new THREE.Mesh(geometry, material);
      const offset = new THREE.Vector3(0,0,-0.8).applyQuaternion(camera.quaternion);
      mesh.position.copy(camera.position).add(offset);
      mesh.quaternion.copy(camera.quaternion);
      scene.add(mesh);
      loader.load(url, (tex) => { mesh.material.map = tex; mesh.material.color.set(0xffffff); updateStatus('Photo placed'); });
    }

    function onSessionEndClick() { if (xrSession) xrSession.end(); }

    function updateStatus(msg) {
      const s = document.getElementById('status');
      s.textContent = msg; s.style.display = msg ? 'block' : 'none';
      if (msg) setTimeout(() => { s.style.display = 'none'; }, 5000);
    }

    document.addEventListener('DOMContentLoaded', () => {
      initPhotoGrid(); initXR();
      document.getElementById('enter-ar').addEventListener('click', startARSession);
      document.getElementById('exit-ar').addEventListener('click', onSessionEndClick);
    });
  </script>
</body>
</html>
